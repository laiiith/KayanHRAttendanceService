CREATE DATABASE IF NOT EXISTS kayan_db;
USE kayan_db;

DROP TABLE IF EXISTS KayanAttendance;

CREATE TABLE KayanAttendance (
    TID INT PRIMARY KEY,
    EmployeeCardNumber VARCHAR(50),
    AttendanceDate DATETIME,
    FunctionType VARCHAR(20),
    MachineName VARCHAR(50),
    Flag INT DEFAULT 0
);

INSERT INTO KayanAttendance (TID, EmployeeCardNumber, AttendanceDate, FunctionType, MachineName)
VALUES
(1, 'EMP001', '2025-06-04 08:01:00', 'CheckIn', 'Machine_A'),
-- ... more rows ...
(10, 'EMP005', '2025-06-04 16:59:00', 'CheckOut', 'Machine_A');

DROP PROCEDURE IF EXISTS sp_FetchAttendance;
DELIMITER //
CREATE PROCEDURE sp_FetchAttendance()
BEGIN
    SELECT 
        TID AS TId,
        EmployeeCardNumber AS EmployeeCode,
        CAST(AttendanceDate AS CHAR) AS PunchTime,
        FunctionType AS `Function`,
        MachineName
    FROM KayanAttendance;
END //
DELIMITER ;

DROP PROCEDURE IF EXISTS sp_UpdateFetchedAttendance;
DELIMITER //
CREATE PROCEDURE sp_UpdateFetchedAttendance()
BEGIN
    UPDATE KayanAttendance AS ka
    JOIN temp_tvp AS temp ON ka.TID = temp.tid
    SET ka.Flag = temp.flag;
END //
DELIMITER ;
